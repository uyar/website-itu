

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>5. Logins &mdash; Flask Tutorial</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="6. Persistence" href="persistence.html" />
    <link rel="prev" title="4. Forms" href="forms.html" /> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="index.html" class="icon icon-home"> Flask Application Development
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="basics.html">1. Basics</a></li>
<li class="toctree-l1"><a class="reference internal" href="application-structure.html">2. Application Structure</a></li>
<li class="toctree-l1"><a class="reference internal" href="data-model.html">3. Data Model</a></li>
<li class="toctree-l1"><a class="reference internal" href="forms.html">4. Forms</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">5. Logins</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#storing-passwords">5.1. Storing Passwords</a></li>
<li class="toctree-l2"><a class="reference internal" href="#login-management">5.2. Login Management</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="persistence.html">6. Persistence</a></li>
<li class="toctree-l1"><a class="reference internal" href="solutions.html">7. Solutions to Exercises</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Flask Application Development</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>5. Logins</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="logins">
<h1>5. Logins<a class="headerlink" href="#logins" title="Permalink to this headline">¶</a></h1>
<p>As our next step, we want to make sure that only authenticated users will be
able to modify the collection. So we’ll need a way of logging users in to and
out of our site. We’ll create two users: the <code class="docutils literal notranslate"><span class="pre">normaluser</span></code> (password
<code class="docutils literal notranslate"><span class="pre">normaluserpw</span></code>) will be able to edit existing movies, but only the <code class="docutils literal notranslate"><span class="pre">admin</span></code>
(password <code class="docutils literal notranslate"><span class="pre">adminpw</span></code>) user will be able to add or delete movies.</p>
<div class="section" id="storing-passwords">
<h2>5.1. Storing Passwords<a class="headerlink" href="#storing-passwords" title="Permalink to this headline">¶</a></h2>
<p>Applications should never store passwords in plain text, or even encrypted.
The correct way to store a password is after hashing it.
The <a class="reference external" href="https://passlib.readthedocs.io/">passlib</a> package provides the necessary
tools for storing passwords securely. After installing it, you can hash
a password as shown in the example Python session below:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">passlib.hash</span> <span class="kn">import</span> <span class="n">pbkdf2_sha256</span> <span class="k">as</span> <span class="n">hasher</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">password</span> <span class="o">=</span> <span class="s2">&quot;adminpw&quot;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">hashed</span> <span class="o">=</span> <span class="n">hasher</span><span class="o">.</span><span class="n">hash</span><span class="p">(</span><span class="n">password</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">hashed</span>
<span class="go">&#39;$pbkdf2-sha256$29000$PIdwDqH03hvjXAuhlLL2Pg$B1K8TX6Efq3GzvKlxDKIk4T7yJzIIzsuSegjZ6hAKLk&#39;</span>
</pre></div>
</div>
<p>Later, when a user supplies a password, you can check whether it’s the correct
password or not by verifying it against the hashed value:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">hasher</span><span class="o">.</span><span class="n">verify</span><span class="p">(</span><span class="s2">&quot;admin_pw&quot;</span><span class="p">,</span> <span class="n">hashed</span><span class="p">)</span>
<span class="go">False</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">hasher</span><span class="o">.</span><span class="n">verify</span><span class="p">(</span><span class="s2">&quot;adminpw&quot;</span><span class="p">,</span> <span class="n">hashed</span><span class="p">)</span>
<span class="go">True</span>
</pre></div>
</div>
<p>Although the proper place to store hashed passwords would be a file
or a database, for this example we’re going to store them in the settings file
as a map from usernames to passwords (<a class="reference internal" href="#lst-settings-v0501"><span class="std std-numref">Listing 5.1</span></a>).
The <code class="docutils literal notranslate"><span class="pre">ADMIN_USERS</span></code> setting lists the usernames who have administrative
privileges.</p>
<div class="literal-block-wrapper docutils container" id="id2">
<span id="lst-settings-v0501"></span><div class="code-block-caption"><span class="caption-number">Listing 5.1 </span><span class="caption-text">Setting for passwords
(file:&nbsp;<code class="file docutils literal notranslate"><span class="pre">settings.py</span></code>, version:&nbsp;<code class="docutils literal notranslate"><span class="pre">v0501</span></code>).</span><a class="headerlink" href="#id2" title="Permalink to this code">¶</a></div>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">DEBUG</span> <span class="o">=</span> <span class="bp">True</span>
<span class="n">PORT</span> <span class="o">=</span> <span class="mi">8080</span>
<span class="n">SECRET_KEY</span> <span class="o">=</span> <span class="s2">&quot;secret&quot;</span>
<span class="n">WTF_CSRF_ENABLED</span> <span class="o">=</span> <span class="bp">True</span>

<span class="n">PASSWORDS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;admin&quot;</span><span class="p">:</span> <span class="s2">&quot;$pbkdf2-sha256$29000$PIdwDqH03hvjXAuhlLL2Pg$B1K8TX6Efq3GzvKlxDKIk4T7yJzIIzsuSegjZ6hAKLk&quot;</span><span class="p">,</span>
    <span class="s2">&quot;normaluser&quot;</span><span class="p">:</span> <span class="s2">&quot;$pbkdf2-sha256$29000$Umotxdhbq9UaI2TsnTMmZA$uVtN2jo0I/de/Kz9/seebkM0n0MG./KGBc1EPw5X.f0&quot;</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">ADMIN_USERS</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;admin&quot;</span><span class="p">]</span>
</pre></div>
</td></tr></table></div>
</div>
</div>
<div class="section" id="login-management">
<h2>5.2. Login Management<a class="headerlink" href="#login-management" title="Permalink to this headline">¶</a></h2>
<p>For handling login management, we’ll use
the <a class="reference external" href="https://flask-login.readthedocs.io/">Flask-Login</a> plugin. This plugin
requires us to implement a class for representing users on our site
(<a class="reference internal" href="#lst-user-v0501"><span class="std std-numref">Listing 5.2</span></a>). Our user data basically consists of a username and
a password. Flask-Login assumes that there will be a unique string value
for identifying each user. In most cases, this will be the string value
of the database id number for a user. In our example, we will use the username
for this purpose. Flask-Login also keeps an attribute for checking whether
a user is active or not (line 9). And we add an attribute for marking users
with administrative privileges (line 10). For details about how Flask-Login
represents users, check out its documentation.</p>
<div class="literal-block-wrapper docutils container" id="id3">
<span id="lst-user-v0501"></span><div class="code-block-caption"><span class="caption-number">Listing 5.2 </span><span class="caption-text">Model class for users
(file:&nbsp;<code class="file docutils literal notranslate"><span class="pre">user.py</span></code>, version:&nbsp;<code class="docutils literal notranslate"><span class="pre">v0501</span></code>).</span><a class="headerlink" href="#id3" title="Permalink to this code">¶</a></div>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">current_app</span>
<span class="kn">from</span> <span class="nn">flask_login</span> <span class="kn">import</span> <span class="n">UserMixin</span>


<span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">UserMixin</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">username</span> <span class="o">=</span> <span class="n">username</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="n">password</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">active</span> <span class="o">=</span> <span class="bp">True</span>
<span class="hll">        <span class="bp">self</span><span class="o">.</span><span class="n">is_admin</span> <span class="o">=</span> <span class="bp">False</span>
</span>
    <span class="k">def</span> <span class="nf">get_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">username</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_active</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">active</span>


<span class="k">def</span> <span class="nf">get_user</span><span class="p">(</span><span class="n">user_id</span><span class="p">):</span>
    <span class="n">password</span> <span class="o">=</span> <span class="n">current_app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;PASSWORDS&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span> <span class="k">if</span> <span class="n">password</span> <span class="k">else</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="n">user</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">user</span><span class="o">.</span><span class="n">is_admin</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">username</span> <span class="ow">in</span> <span class="n">current_app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;ADMIN_USERS&quot;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">user</span>
</pre></div>
</td></tr></table></div>
</div>
<p>We also implement a function that given a user’s id, returns the user
object associated with that id (lines 20-25). It first checks whether
there is an entry in the passwords map, and if so, creates the user object
(lines 21-22). It also sets the <code class="docutils literal notranslate"><span class="pre">is_admin</span></code> property according to the user
being in the <code class="docutils literal notranslate"><span class="pre">ADMIN_USERS</span></code> settings or not (line 24).</p>
<p>To incorporate Flask-Login, we have to instantiate a <code class="docutils literal notranslate"><span class="pre">LoginManager</span></code>
(lines 2 and 10) and add it to our application (line 42). We add two URL rules
for the login and logout pages (lines 24-27). If a visitor makes a request
to a protected page without logging in, we can redirect the request
to the login page by setting the <code class="docutils literal notranslate"><span class="pre">login_view</span></code> property of the login manager
(line 43). And finally, a user loader function will be responsible for creating
a user object from the user id in the session (lines 7 and 13-15).</p>
<div class="literal-block-wrapper docutils container" id="id4">
<span id="lst-server-v0501"></span><div class="code-block-caption"><span class="caption-number">Listing 5.3 </span><span class="caption-text">Application with login manager
(file:&nbsp;<code class="file docutils literal notranslate"><span class="pre">server.py</span></code>, version:&nbsp;<code class="docutils literal notranslate"><span class="pre">v0501</span></code>).</span><a class="headerlink" href="#id4" title="Permalink to this code">¶</a></div>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>
<span class="hll"><span class="kn">from</span> <span class="nn">flask_login</span> <span class="kn">import</span> <span class="n">LoginManager</span>
</span>
<span class="kn">import</span> <span class="nn">views</span>
<span class="kn">from</span> <span class="nn">database</span> <span class="kn">import</span> <span class="n">Database</span>
<span class="kn">from</span> <span class="nn">movie</span> <span class="kn">import</span> <span class="n">Movie</span>
<span class="hll"><span class="kn">from</span> <span class="nn">user</span> <span class="kn">import</span> <span class="n">get_user</span>
</span>

<span class="hll"><span class="n">lm</span> <span class="o">=</span> <span class="n">LoginManager</span><span class="p">()</span>
</span>

<span class="hll"><span class="nd">@lm.user_loader</span>
</span><span class="hll"><span class="k">def</span> <span class="nf">load_user</span><span class="p">(</span><span class="n">user_id</span><span class="p">):</span>
</span><span class="hll">    <span class="k">return</span> <span class="n">get_user</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
</span>

<span class="k">def</span> <span class="nf">create_app</span><span class="p">():</span>
    <span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
    <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">from_object</span><span class="p">(</span><span class="s2">&quot;settings&quot;</span><span class="p">)</span>

    <span class="n">app</span><span class="o">.</span><span class="n">add_url_rule</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="n">view_func</span><span class="o">=</span><span class="n">views</span><span class="o">.</span><span class="n">home_page</span><span class="p">)</span>

<span class="hll">    <span class="n">app</span><span class="o">.</span><span class="n">add_url_rule</span><span class="p">(</span>
</span><span class="hll">        <span class="s2">&quot;/login&quot;</span><span class="p">,</span> <span class="n">view_func</span><span class="o">=</span><span class="n">views</span><span class="o">.</span><span class="n">login_page</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="s2">&quot;POST&quot;</span><span class="p">]</span>
</span><span class="hll">    <span class="p">)</span>
</span><span class="hll">    <span class="n">app</span><span class="o">.</span><span class="n">add_url_rule</span><span class="p">(</span><span class="s2">&quot;/logout&quot;</span><span class="p">,</span> <span class="n">view_func</span><span class="o">=</span><span class="n">views</span><span class="o">.</span><span class="n">logout_page</span><span class="p">)</span>
</span>
    <span class="n">app</span><span class="o">.</span><span class="n">add_url_rule</span><span class="p">(</span>
        <span class="s2">&quot;/movies&quot;</span><span class="p">,</span> <span class="n">view_func</span><span class="o">=</span><span class="n">views</span><span class="o">.</span><span class="n">movies_page</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="s2">&quot;POST&quot;</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">app</span><span class="o">.</span><span class="n">add_url_rule</span><span class="p">(</span><span class="s2">&quot;/movies/&lt;int:movie_key&gt;&quot;</span><span class="p">,</span> <span class="n">view_func</span><span class="o">=</span><span class="n">views</span><span class="o">.</span><span class="n">movie_page</span><span class="p">)</span>
    <span class="n">app</span><span class="o">.</span><span class="n">add_url_rule</span><span class="p">(</span>
        <span class="s2">&quot;/movies/&lt;int:movie_key&gt;/edit&quot;</span><span class="p">,</span>
        <span class="n">view_func</span><span class="o">=</span><span class="n">views</span><span class="o">.</span><span class="n">movie_edit_page</span><span class="p">,</span>
        <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="s2">&quot;POST&quot;</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="n">app</span><span class="o">.</span><span class="n">add_url_rule</span><span class="p">(</span>
        <span class="s2">&quot;/new-movie&quot;</span><span class="p">,</span> <span class="n">view_func</span><span class="o">=</span><span class="n">views</span><span class="o">.</span><span class="n">movie_add_page</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="s2">&quot;POST&quot;</span><span class="p">]</span>
    <span class="p">)</span>

<span class="hll">    <span class="n">lm</span><span class="o">.</span><span class="n">init_app</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
</span><span class="hll">    <span class="n">lm</span><span class="o">.</span><span class="n">login_view</span> <span class="o">=</span> <span class="s2">&quot;login_page&quot;</span>
</span>
    <span class="n">db</span> <span class="o">=</span> <span class="n">Database</span><span class="p">()</span>
    <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;db&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">db</span>

    <span class="k">return</span> <span class="n">app</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">app</span> <span class="o">=</span> <span class="n">create_app</span><span class="p">()</span>
    <span class="n">port</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;PORT&quot;</span><span class="p">,</span> <span class="mi">5000</span><span class="p">)</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s2">&quot;0.0.0.0&quot;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">port</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
</div>
<p>Let’s create a form for our login page (<a class="reference internal" href="#lst-forms-v0501"><span class="std std-numref">Listing 5.4</span></a>).</p>
<div class="literal-block-wrapper docutils container" id="id5">
<span id="lst-forms-v0501"></span><div class="code-block-caption"><span class="caption-number">Listing 5.4 </span><span class="caption-text">Login page form
(file:&nbsp;<code class="file docutils literal notranslate"><span class="pre">forms.py</span></code>, version:&nbsp;<code class="docutils literal notranslate"><span class="pre">v0501</span></code>).</span><a class="headerlink" href="#id5" title="Permalink to this code">¶</a></div>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">LoginForm</span><span class="p">(</span><span class="n">FlaskForm</span><span class="p">):</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">StringField</span><span class="p">(</span><span class="s2">&quot;Username&quot;</span><span class="p">,</span> <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">DataRequired</span><span class="p">()])</span>

    <span class="n">password</span> <span class="o">=</span> <span class="n">PasswordField</span><span class="p">(</span><span class="s2">&quot;Password&quot;</span><span class="p">,</span> <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">DataRequired</span><span class="p">()])</span>
</pre></div>
</td></tr></table></div>
</div>
<p>Next, we add the template for this form (<a class="reference internal" href="#lst-login-v0501"><span class="std std-numref">Listing 5.5</span></a>).</p>
<div class="literal-block-wrapper docutils container" id="id6">
<span id="lst-login-v0501"></span><div class="code-block-caption"><span class="caption-number">Listing 5.5 </span><span class="caption-text">Login page template
(file:&nbsp;<code class="file docutils literal notranslate"><span class="pre">templates/login.html</span></code>, version:&nbsp;<code class="docutils literal notranslate"><span class="pre">v0501</span></code>).</span><a class="headerlink" href="#id6" title="Permalink to this code">¶</a></div>
<div class="highlight-html notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47</pre></div></td><td class="code"><div class="highlight"><pre><span></span>{% extends &quot;layout.html&quot; %}
{% block title %}Login{% endblock %}
{% block content %}
    <span class="p">&lt;</span><span class="nt">section</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;hero&quot;</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;hero-body&quot;</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;container has-text-centered&quot;</span><span class="p">&gt;</span>
          <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;column is-4 is-offset-4&quot;</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">h3</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;title has-text-grey&quot;</span><span class="p">&gt;</span>Login<span class="p">&lt;/</span><span class="nt">h3</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;box&quot;</span><span class="p">&gt;</span>
              <span class="p">&lt;</span><span class="nt">form</span> <span class="na">action</span><span class="o">=</span><span class="s">&quot;&quot;</span> <span class="na">method</span><span class="o">=</span><span class="s">&quot;post&quot;</span> <span class="na">name</span><span class="o">=</span><span class="s">&quot;login&quot;</span><span class="p">&gt;</span>
                {{ form.csrf_token }}

                <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;field&quot;</span><span class="p">&gt;</span>
                  <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;control&quot;</span><span class="p">&gt;</span>
                    {{ form.username(required=True, autofocus=True,
                                     class=&#39;input is-large&#39;,
                                     placeholder=&#39;your username&#39;) }}
                  <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
                  {% for error in form.username.errors %}
                    <span class="p">&lt;</span><span class="nt">p</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;help has-background-warning&quot;</span><span class="p">&gt;</span>
                        {{ error }}
                    <span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
                  {% endfor %}
                <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>

                <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;field&quot;</span><span class="p">&gt;</span>
                  <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;control&quot;</span><span class="p">&gt;</span>
                    {{ form.password(required=True, class=&#39;input is-large&#39;,
                                     placeholder=&#39;your password&#39;) }}
                  <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
                  {% for error in form.password.errors %}
                    <span class="p">&lt;</span><span class="nt">p</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;help has-background-warning&quot;</span><span class="p">&gt;</span>
                        {{ error }}
                    <span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
                  {% endfor %}
                <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>

                <span class="p">&lt;</span><span class="nt">button</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;button is-block is-info is-large is-fullwidth&quot;</span><span class="p">&gt;</span>
                  Login
                <span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
              <span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
            <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
          <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
        <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
      <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">section</span><span class="p">&gt;</span>
{% endblock %}
</pre></div>
</td></tr></table></div>
</div>
<p>The navigation part of the layout template is given in
<a class="reference internal" href="#lst-layout-login-v0501"><span class="std std-numref">Listing 5.6</span></a>. Note the following changes:</p>
<ul class="simple">
<li>If the visitor is not logged in, a login link is displayed (line 16).</li>
<li>If the visitor is logged in, the username is displayed along with a logout
link (lines 18-19).</li>
<li>The menu item for adding a movie is only shown to administrative users
(lines 9-13).</li>
</ul>
<div class="literal-block-wrapper docutils container" id="id7">
<span id="lst-layout-login-v0501"></span><div class="code-block-caption"><span class="caption-number">Listing 5.6 </span><span class="caption-text">Base layout with login link
(file:&nbsp;<code class="file docutils literal notranslate"><span class="pre">templates/layout.html</span></code>, version:&nbsp;<code class="docutils literal notranslate"><span class="pre">v0501</span></code>).</span><a class="headerlink" href="#id7" title="Permalink to this code">¶</a></div>
<div class="highlight-html notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23</pre></div></td><td class="code"><div class="highlight"><pre><span></span>      <span class="p">&lt;</span><span class="nt">nav</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;navbar&quot;</span> <span class="na">aria-label</span><span class="o">=</span><span class="s">&quot;main navigation&quot;</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;navbar-brand&quot;</span><span class="p">&gt;</span>
          <span class="p">&lt;</span><span class="nt">span</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;navbar-item&quot;</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">a</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;button is-link&quot;</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;{{ url_for(&#39;home_page&#39;) }}&quot;</span><span class="p">&gt;</span>Home<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
          <span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
          <span class="p">&lt;</span><span class="nt">span</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;navbar-item&quot;</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">a</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;button is-link&quot;</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;{{ url_for(&#39;movies_page&#39;) }}&quot;</span><span class="p">&gt;</span>List movies<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
          <span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
<span class="hll">          {% if current_user.is_admin %}
</span><span class="hll">          <span class="p">&lt;</span><span class="nt">span</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;navbar-item&quot;</span><span class="p">&gt;</span>
</span><span class="hll">            <span class="p">&lt;</span><span class="nt">a</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;button is-link&quot;</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;{{ url_for(&#39;movie_add_page&#39;) }}&quot;</span><span class="p">&gt;</span>Add movie<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
</span><span class="hll">          <span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
</span><span class="hll">          {% endif %}
</span>          <span class="p">&lt;</span><span class="nt">span</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;navbar-item&quot;</span><span class="p">&gt;</span>
<span class="hll">          {% if not current_user.is_authenticated %}
</span><span class="hll">            <span class="p">&lt;</span><span class="nt">a</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;button is-link&quot;</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;{{ url_for(&#39;login_page&#39;) }}&quot;</span><span class="p">&gt;</span>Log in<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
</span><span class="hll">          {% else %}
</span><span class="hll">            {{ current_user.username }}
</span><span class="hll">            <span class="p">&lt;</span><span class="nt">a</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;button is-link&quot;</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;{{ url_for(&#39;logout_page&#39;) }}&quot;</span><span class="p">&gt;</span>Log out<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
</span><span class="hll">          {% endif %}
</span>          <span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
        <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
      <span class="p">&lt;/</span><span class="nt">nav</span><span class="p">&gt;</span>
</pre></div>
</td></tr></table></div>
</div>
<p>The view functions for the login and logout pages are given in
<a class="reference internal" href="#lst-views-login-v0501"><span class="std std-numref">Listing 5.7</span></a>. The supplied username will be used
to get a user object from the registered users (lines 4-5). If such a user
is found, it will have a hashed <code class="docutils literal notranslate"><span class="pre">password</span></code> attribute which can be checked
against the password sent by the user (lines 7-8). Flask-Login provides
functions for handling the login and logout operations easily (lines 9 and
18).</p>
<div class="literal-block-wrapper docutils container" id="id8">
<span id="lst-views-login-v0501"></span><div class="code-block-caption"><span class="caption-number">Listing 5.7 </span><span class="caption-text">Handlers for login and logout pages
(file:&nbsp;<code class="file docutils literal notranslate"><span class="pre">views.py</span></code>, version:&nbsp;<code class="docutils literal notranslate"><span class="pre">v0501</span></code>).</span><a class="headerlink" href="#id8" title="Permalink to this code">¶</a></div>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">login_page</span><span class="p">():</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">LoginForm</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">validate_on_submit</span><span class="p">():</span>
        <span class="n">username</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;username&quot;</span><span class="p">]</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">get_user</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">user</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">password</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;password&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">hasher</span><span class="o">.</span><span class="n">verify</span><span class="p">(</span><span class="n">password</span><span class="p">,</span> <span class="n">user</span><span class="o">.</span><span class="n">password</span><span class="p">):</span>
<span class="hll">                <span class="n">login_user</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
</span>                <span class="n">flash</span><span class="p">(</span><span class="s2">&quot;You have logged in.&quot;</span><span class="p">)</span>
                <span class="n">next_page</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;next&quot;</span><span class="p">,</span> <span class="n">url_for</span><span class="p">(</span><span class="s2">&quot;home_page&quot;</span><span class="p">))</span>
                <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">next_page</span><span class="p">)</span>
        <span class="n">flash</span><span class="p">(</span><span class="s2">&quot;Invalid credentials.&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s2">&quot;login.html&quot;</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="n">form</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">logout_page</span><span class="p">():</span>
<span class="hll">    <span class="n">logout_user</span><span class="p">()</span>
</span>    <span class="n">flash</span><span class="p">(</span><span class="s2">&quot;You have logged out.&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s2">&quot;home_page&quot;</span><span class="p">))</span>
</pre></div>
</td></tr></table></div>
</div>
<p>The redirection to the next page (lines 11-12) is needed to handle the cases
where the user will be automatically redirected when accessing protected pages.
For example, if an anonymous user visits the <code class="docutils literal notranslate"><span class="pre">/movies/add</span></code> page, they will be
redirected to the login page (because of the <code class="docutils literal notranslate"><span class="pre">login_view</span></code> setting,
<a class="reference internal" href="#lst-server-v0501"><span class="std std-numref">Listing 5.3</span></a>, line 43), and after successfully logging in,
this part will redirect the user back to the movie addition page.</p>
<p>Another feature provided by Flask is to easily display messages to logged-in
users. The <code class="docutils literal notranslate"><span class="pre">flash</span></code> function registers a message that the user will see
on the next page (lines 10 and 19). To display these messages, we have to add
the necessary markup to the base layout template (<a class="reference internal" href="#lst-layout-v0501"><span class="std std-numref">Listing 5.8</span></a>,
lines 2-4).</p>
<div class="literal-block-wrapper docutils container" id="id9">
<span id="lst-layout-v0501"></span><div class="code-block-caption"><span class="caption-number">Listing 5.8 </span><span class="caption-text">Base layout with notification messages
(file:&nbsp;<code class="file docutils literal notranslate"><span class="pre">templates/layout.html</span></code>, version:&nbsp;<code class="docutils literal notranslate"><span class="pre">v0501</span></code>).</span><a class="headerlink" href="#id9" title="Permalink to this code">¶</a></div>
<div class="highlight-html notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="highlight"><pre><span></span>    <span class="p">&lt;</span><span class="nt">main</span><span class="p">&gt;</span>
<span class="hll">        {% for message in get_flashed_messages() %}
</span><span class="hll">        <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;notification is-info&quot;</span><span class="p">&gt;</span>{{ message }}<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</span><span class="hll">        {% endfor %}
</span>
      <span class="p">&lt;</span><span class="nt">section</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;section&quot;</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;content&quot;</span><span class="p">&gt;</span>
          {% block content %}{% endblock %}
        <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
      <span class="p">&lt;/</span><span class="nt">section</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">main</span><span class="p">&gt;</span>
</pre></div>
</td></tr></table></div>
</div>
<p>We can simply protect a page by adding the <code class="docutils literal notranslate"><span class="pre">login_required</span></code> decorator
to its view function. For example, to make sure that only authenticated users
can add or edit movie data we can decorate the relevant view functions
(<a class="reference internal" href="#lst-views-v0501"><span class="std std-numref">Listing 5.9</span></a>).</p>
<div class="literal-block-wrapper docutils container" id="id10">
<span id="lst-views-v0501"></span><div class="code-block-caption"><span class="caption-number">Listing 5.9 </span><span class="caption-text">Protecting the movie add and edit pages
(file:&nbsp;<code class="file docutils literal notranslate"><span class="pre">views.py</span></code>, version:&nbsp;<code class="docutils literal notranslate"><span class="pre">v0501</span></code>).</span><a class="headerlink" href="#id10" title="Permalink to this code">¶</a></div>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="hll"><span class="nd">@login_required</span>
</span><span class="k">def</span> <span class="nf">movie_add_page</span><span class="p">():</span>
<span class="hll">    <span class="k">if</span> <span class="ow">not</span> <span class="n">current_user</span><span class="o">.</span><span class="n">is_admin</span><span class="p">:</span>
</span><span class="hll">        <span class="n">abort</span><span class="p">(</span><span class="mi">401</span><span class="p">)</span>
</span>    <span class="n">form</span> <span class="o">=</span> <span class="n">MovieEditForm</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">validate_on_submit</span><span class="p">():</span>
        <span class="n">title</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">]</span>
        <span class="n">year</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;year&quot;</span><span class="p">]</span>
        <span class="n">movie</span> <span class="o">=</span> <span class="n">Movie</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">year</span><span class="o">=</span><span class="n">year</span><span class="p">)</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">current_app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;db&quot;</span><span class="p">]</span>
        <span class="n">movie_key</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">add_movie</span><span class="p">(</span><span class="n">movie</span><span class="p">)</span>
        <span class="n">flash</span><span class="p">(</span><span class="s2">&quot;Movie added.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s2">&quot;movie_page&quot;</span><span class="p">,</span> <span class="n">movie_key</span><span class="o">=</span><span class="n">movie_key</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s2">&quot;movie_edit.html&quot;</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="n">form</span><span class="p">)</span>


<span class="hll"><span class="nd">@login_required</span>
</span><span class="k">def</span> <span class="nf">movie_edit_page</span><span class="p">(</span><span class="n">movie_key</span><span class="p">):</span>
    <span class="n">db</span> <span class="o">=</span> <span class="n">current_app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;db&quot;</span><span class="p">]</span>
    <span class="n">movie</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_movie</span><span class="p">(</span><span class="n">movie_key</span><span class="p">)</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">MovieEditForm</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">validate_on_submit</span><span class="p">():</span>
        <span class="n">title</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">]</span>
        <span class="n">year</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;year&quot;</span><span class="p">]</span>
        <span class="n">movie</span> <span class="o">=</span> <span class="n">Movie</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">year</span><span class="o">=</span><span class="n">year</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">update_movie</span><span class="p">(</span><span class="n">movie_key</span><span class="p">,</span> <span class="n">movie</span><span class="p">)</span>
        <span class="n">flash</span><span class="p">(</span><span class="s2">&quot;Movie data updated.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s2">&quot;movie_page&quot;</span><span class="p">,</span> <span class="n">movie_key</span><span class="o">=</span><span class="n">movie_key</span><span class="p">))</span>
    <span class="n">form</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">movie</span><span class="o">.</span><span class="n">title</span>
    <span class="n">form</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">movie</span><span class="o">.</span><span class="n">year</span> <span class="k">if</span> <span class="n">movie</span><span class="o">.</span><span class="n">year</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s2">&quot;movie_edit.html&quot;</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="n">form</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
</div>
<p>In addition to the login requirement, we also want to prevent normal users
from adding movies, so we add role based protections to the view function
(<a class="reference internal" href="#lst-views-v0501"><span class="std std-numref">Listing 5.9</span></a>, lines 3-4). In this example, the <code class="docutils literal notranslate"><span class="pre">abort</span></code>
function will cause an “Unauthorized” error due to the 401 HTTP status code.
Similarly, to prevent normal users from deleting movies we modify
the movie page view function (<a class="reference internal" href="#lst-views-delete-v0501"><span class="std std-numref">Listing 5.10</span></a>, lines 7-8).
Note that this page is not login protected.</p>
<div class="literal-block-wrapper docutils container" id="id11">
<span id="lst-views-delete-v0501"></span><div class="code-block-caption"><span class="caption-number">Listing 5.10 </span><span class="caption-text">Protecting the movie delete operation
(file:&nbsp;<code class="file docutils literal notranslate"><span class="pre">views.py</span></code>, version:&nbsp;<code class="docutils literal notranslate"><span class="pre">v0501</span></code>).</span><a class="headerlink" href="#id11" title="Permalink to this code">¶</a></div>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">movies_page</span><span class="p">():</span>
    <span class="n">db</span> <span class="o">=</span> <span class="n">current_app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;db&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;GET&quot;</span><span class="p">:</span>
        <span class="n">movies</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_movies</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s2">&quot;movies.html&quot;</span><span class="p">,</span> <span class="n">movies</span><span class="o">=</span><span class="nb">sorted</span><span class="p">(</span><span class="n">movies</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
<span class="hll">        <span class="k">if</span> <span class="ow">not</span> <span class="n">current_user</span><span class="o">.</span><span class="n">is_admin</span><span class="p">:</span>
</span><span class="hll">            <span class="n">abort</span><span class="p">(</span><span class="mi">401</span><span class="p">)</span>
</span>        <span class="n">form_movie_keys</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">getlist</span><span class="p">(</span><span class="s2">&quot;movie_keys&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">form_movie_key</span> <span class="ow">in</span> <span class="n">form_movie_keys</span><span class="p">:</span>
            <span class="n">db</span><span class="o">.</span><span class="n">delete_movie</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">form_movie_key</span><span class="p">))</span>
        <span class="n">flash</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%(num)d</span><span class="s2"> movies deleted.&quot;</span> <span class="o">%</span> <span class="p">{</span><span class="s2">&quot;num&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">form_movie_keys</span><span class="p">)})</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s2">&quot;movies_page&quot;</span><span class="p">))</span>
</pre></div>
</td></tr></table></div>
</div>
<p>It would be a good idea to reflect these protections to the templates and
to not display any operations for which the user doesn’t have the necessary
privileges. For example, we can organize the movie display template as in
<a class="reference internal" href="#lst-movie-v0501"><span class="std std-numref">Listing 5.11</span></a> (lines 19 and 26) so they won’t see the movie
edit button at all.</p>
<div class="literal-block-wrapper docutils container" id="id12">
<span id="lst-movie-v0501"></span><div class="code-block-caption"><span class="caption-number">Listing 5.11 </span><span class="caption-text">Showing the edit button only to authenticated users
(file:&nbsp;<code class="file docutils literal notranslate"><span class="pre">templates/movie.html</span></code>, version:&nbsp;<code class="docutils literal notranslate"><span class="pre">v0501</span></code>).</span><a class="headerlink" href="#id12" title="Permalink to this code">¶</a></div>
<div class="highlight-html notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27</pre></div></td><td class="code"><div class="highlight"><pre><span></span>{% extends &quot;layout.html&quot; %}
{% block title %}Movie{% endblock %}
{% block content %}
    <span class="p">&lt;</span><span class="nt">h1</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;title&quot;</span><span class="p">&gt;</span>Movie<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>

    <span class="p">&lt;</span><span class="nt">table</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;table&quot;</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">tr</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">th</span><span class="p">&gt;</span>Title:<span class="p">&lt;/</span><span class="nt">th</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>{{ movie.title }}<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
      <span class="p">&lt;/</span><span class="nt">tr</span><span class="p">&gt;</span>
      {% if movie.year %}
      <span class="p">&lt;</span><span class="nt">tr</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">th</span><span class="p">&gt;</span>Year:<span class="p">&lt;/</span><span class="nt">th</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>{{ movie.year }}<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
      <span class="p">&lt;/</span><span class="nt">tr</span><span class="p">&gt;</span>
      {% endif %}
    <span class="p">&lt;/</span><span class="nt">table</span><span class="p">&gt;</span>

<span class="hll">    {% if current_user.is_authenticated %}
</span>    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;field is-grouped&quot;</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;control&quot;</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">a</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;button is-primary is-outlined is-small&quot;</span>
           <span class="na">href</span><span class="o">=</span><span class="s">&quot;{{ request.path }}/edit&quot;</span><span class="p">&gt;</span>Edit<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
      <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="hll">    {% endif %}
</span>{% endblock %}
</pre></div>
</td></tr></table></div>
</div>
<p>We also have to modify the template (<a class="reference internal" href="#lst-delete-v0501"><span class="std std-numref">Listing 5.12</span></a>) for movie
deletions in order to restrict the operation to administrative users. Here,
we’re not only hiding the delete button from non-administrative users
(lines 26-32), we’re also hiding the check boxes (lines 12-16) because they
wouldn’t make sense without the button.</p>
<div class="literal-block-wrapper docutils container" id="id13">
<span id="lst-delete-v0501"></span><div class="code-block-caption"><span class="caption-number">Listing 5.12 </span><span class="caption-text">Protecting the delete operation
(file:&nbsp;<code class="file docutils literal notranslate"><span class="pre">templates/movies.html</span></code>, version:&nbsp;<code class="docutils literal notranslate"><span class="pre">v0501</span></code>).</span><a class="headerlink" href="#id13" title="Permalink to this code">¶</a></div>
<div class="highlight-html notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35</pre></div></td><td class="code"><div class="highlight"><pre><span></span>{% extends &quot;layout.html&quot; %}
{% block title %}Movie list{% endblock %}
{% block content %}
    <span class="p">&lt;</span><span class="nt">h1</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;title&quot;</span><span class="p">&gt;</span>Movies<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>

    {% if movies %}
    <span class="p">&lt;</span><span class="nt">form</span> <span class="na">action</span><span class="o">=</span><span class="s">&quot;&quot;</span> <span class="na">method</span><span class="o">=</span><span class="s">&quot;post&quot;</span> <span class="na">name</span><span class="o">=</span><span class="s">&quot;movie_list&quot;</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">table</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;table is-striped is-fullwidth&quot;</span><span class="p">&gt;</span>
        {% for movie_key, movie in movies %}
        <span class="p">&lt;</span><span class="nt">tr</span><span class="p">&gt;</span>
          <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>
<span class="hll">            {% if current_user.is_admin %}
</span><span class="hll">            <span class="p">&lt;</span><span class="nt">label</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;checkbox&quot;</span><span class="p">&gt;</span>
</span><span class="hll">              <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;checkbox&quot;</span> <span class="na">name</span><span class="o">=</span><span class="s">&quot;movie_keys&quot;</span> <span class="na">value</span><span class="o">=</span><span class="s">&quot;{{ movie_key }}&quot;</span><span class="p">/&gt;</span>
</span><span class="hll">            <span class="p">&lt;/</span><span class="nt">label</span><span class="p">&gt;</span>
</span><span class="hll">            {% endif %}
</span>            <span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;{{ url_for(&#39;movie_page&#39;, movie_key=movie_key) }}&quot;</span><span class="p">&gt;</span>
              {{ movie.title }}
              {% if movie.year %} ({{ movie.year }}) {% endif %}
            <span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
          <span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
        <span class="p">&lt;/</span><span class="nt">tr</span><span class="p">&gt;</span>
        {% endfor %}
      <span class="p">&lt;/</span><span class="nt">table</span><span class="p">&gt;</span>

<span class="hll">      {% if current_user.is_admin %}
</span><span class="hll">      <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;field is-grouped&quot;</span><span class="p">&gt;</span>
</span><span class="hll">        <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;control&quot;</span><span class="p">&gt;</span>
</span><span class="hll">          <span class="p">&lt;</span><span class="nt">button</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;button is-danger is-small&quot;</span><span class="p">&gt;</span>Delete<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
</span><span class="hll">        <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</span><span class="hll">      <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</span><span class="hll">      {% endif %}
</span>    <span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
    {% endif %}
{% endblock %}
</pre></div>
</td></tr></table></div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="persistence.html" class="btn btn-neutral float-right" title="6. Persistence" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="forms.html" class="btn btn-neutral" title="4. Forms" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2015-2018, H. Turgut Uyar

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script type="text/javascript" src="_static/jquery.js"></script>
        <script type="text/javascript" src="_static/underscore.js"></script>
        <script type="text/javascript" src="_static/doctools.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    

  

  <script type="text/javascript" src="_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>